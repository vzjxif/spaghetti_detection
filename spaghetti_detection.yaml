blueprint:
  name: Bambu Lab - ç‚’é¢æ£€æµ‹ (Gotify)
  description: "åŸºäº Obico ML çš„æ‰“å°å¤±è´¥æ£€æµ‹ã€‚æ£€æµ‹åˆ°å¤±è´¥æ—¶é€šè¿‡ Gotify å‘é€å¸¦å›¾è­¦æŠ¥ã€‚"
  domain: automation
  input:
    # --- Gotify é…ç½® ---
    gotify_server_url:
      name: Gotify æœåŠ¡å™¨åœ°å€
      description: "Gotify æœåŠ¡å™¨çš„å®Œæ•´ URLï¼ˆå¦‚ http://192.168.1.100:8080ï¼‰"
      default: http://192.168.1.100:8080
    gotify_app_token:
      name: Gotify åº”ç”¨ Token
      description: "åœ¨ Gotify ä¸­åˆ›å»ºåº”ç”¨åè·å–çš„ Token"
      default: your_gotify_app_token

    # --- æœåŠ¡åœ°å€ ---
    public_home_assistant_host:
      name: Home Assistant å…¬ç½‘åœ°å€
      description: Gotify æ¶ˆæ¯ä¸­å›¾ç‰‡çš„è®¿é—®åœ°å€ (å¿…é¡» HTTPS æˆ–å¯è¾¾åœ°å€)ã€‚
      default: https://ha.example.com
    internal_home_assistant_host:
      name: Home Assistant å†…ç½‘åœ°å€
      description: ç”¨äºæœ¬åœ°å®¹å™¨é«˜é€Ÿæ‹‰å–å›¾ç‰‡ã€‚
      default: http://192.168.101.194:8123
    obico_host:
      name: Obico ML API Host
      default: http://192.168.101.236:3333
    obico_auth_token:
      name: Obico ML API Auth Token
      default: example_token

    # --- ç­–ç•¥é…ç½® ---
    detection_frequency:
      name: æ£€æµ‹é¢‘ç‡
      default: "/10"
      selector:
        select:
          options:
            - label: æ¯ 10 ç§’
              value: "/10"
            - label: æ¯ 30 ç§’
              value: "/30"
            - label: æ¯ 60 ç§’
              value: "/59"
          multiple: false
          mode: dropdown
    auto_turn_on_light:
      name: è‡ªåŠ¨å¼€ç¯
      description: æ£€æµ‹æ—¶è‹¥æœºç®±ç¯å…³é—­ï¼Œæ˜¯å¦è‡ªåŠ¨æ‰“å¼€ä»¥è¾…åŠ©æ‘„åƒå¤´ã€‚
      default: true
      selector:
        boolean: {}
    failure_action:
      name: å¤±è´¥åŠ¨ä½œ
      description: ç¡®è®¤ç‚’é¢åï¼Œæ‰“å°æœºæ‰§è¡Œçš„åŠ¨ä½œã€‚
      default: pause
      selector:
        select:
          options:
            - label: æš‚åœæ‰“å° (æ¨è)
              value: pause
            - label: åœæ­¢æ‰“å°
              value: stop
            - label: ä»…è­¦å‘Š
              value: warn
          multiple: false
          mode: dropdown

    # --- å®ä½“ç»‘å®š ---
    printer_print_status_sensor:
      name: æ‰“å°çŠ¶æ€ (Print Status)
      selector:
        entity:
          filter:
            integration: bambu_lab
            domain: sensor
    printer_current_stage_sensor:
      name: å½“å‰é˜¶æ®µ (Current Stage)
      selector:
        entity:
          filter:
            integration: bambu_lab
            domain: sensor
    printer_camera:
      name: æ‘„åƒå¤´ (Camera)
      selector:
        entity:
          filter:
            domain: camera
    printer_pause_button:
      name: æš‚åœæŒ‰é’®
      selector:
        entity:
          filter:
            integration: bambu_lab
            domain: button
    printer_resume_button:
      name: æ¢å¤æŒ‰é’®
      selector:
        entity:
          filter:
            integration: bambu_lab
            domain: button
    printer_stop_button:
      name: åœæ­¢æŒ‰é’®
      selector:
        entity:
          filter:
            integration: bambu_lab
            domain: button
    printer_chamber_light:
      name: æœºç®±ç¯
      selector:
        entity:
          filter:
            integration: bambu_lab
            domain: light

variables:
  GOTIFY_URL: !input gotify_server_url
  GOTIFY_TOKEN: !input gotify_app_token
  PUBLIC_HA_HOST_VAR: !input public_home_assistant_host
  INTERNAL_HA_HOST_VAR: !input internal_home_assistant_host
  PRINTER_CAMERA_VAR: !input printer_camera
  FAILURE_ACTION_VAR: !input failure_action
  DETECTION_FREQUENCY_VAR: !input detection_frequency
  AUTO_LIGHT_VAR: !input auto_turn_on_light

mode: single
max_exceeded: silent

trigger:
  # 1. æ‰“å°å¼€å§‹ï¼šé‡ç½®è®¡æ•°å™¨
  - platform: state
    entity_id:
      - !input printer_current_stage_sensor
    to: printing
    id: BAMBU_LAB_PRINTER_STAGE_CHANGE

  # 2. å¾ªç¯æ£€æµ‹
  - platform: time_pattern
    id: BAMBU_LAB_DETECTION_TRIGGER
    seconds: !input detection_frequency

action:
  - choose:
      # =======================================================
      # åœºæ™¯ 1: åˆå§‹åŒ– (é‡ç½®æ•°å­¦æ¨¡å‹å‚æ•°)
      # =======================================================
      - conditions:
          - condition: trigger
            id: BAMBU_LAB_PRINTER_STAGE_CHANGE
        sequence:
          - service: number.set_value
            data:
              value: 0
            target:
              entity_id:
                - number.bambu_lab_p1_spaghetti_detection_current_frame_number
                - number.bambu_lab_p1_spaghetti_detection_ewm_mean
                - number.bambu_lab_p1_spaghetti_detection_rolling_mean_short
                - number.bambu_lab_p1_spaghetti_detection_rolling_mean_long
                - number.bambu_lab_p1_spaghetti_detection_normalized_p
                - number.bambu_lab_p1_spaghetti_detection_adjusted_ewm_mean
                - number.bambu_lab_p1_spaghetti_detection_p_sum
          - if:
              - condition: template
                value_template: "{{ is_state(printer_chamber_light, 'off') and AUTO_LIGHT_VAR }}"
            then:
              - service: light.turn_on
                target:
                  entity_id: !input printer_chamber_light

      # =======================================================
      # åœºæ™¯ 2: æ‰§è¡Œæ£€æµ‹ä¸ ML è®¡ç®—
      # =======================================================
      - conditions:
          - condition: trigger
            id: BAMBU_LAB_DETECTION_TRIGGER
        sequence:
          # 2.1 çŠ¶æ€æ£€æŸ¥
          - if:
              - condition: template
                value_template: "{{ not is_state(printer_print_status_sensor, 'running') }}"
            then:
              - stop: "Printer is not running."

          # 2.2 è‡ªåŠ¨è¡¥å…‰
          - if:
              - condition: template
                value_template: "{{ is_state(printer_chamber_light, 'off') and AUTO_LIGHT_VAR }}"
            then:
              - service: light.turn_on
                target:
                  entity_id: !input printer_chamber_light

          # 2.3 è°ƒç”¨ ML é¢„æµ‹ (å†…ç½‘åŠ é€Ÿ)
          - service: bambu_lab_p1_spaghetti_detection.predict
            data:
              obico_host: !input obico_host
              obico_auth_token: !input obico_auth_token
              image_url: "{{ INTERNAL_HA_HOST_VAR }}{{ state_attr(PRINTER_CAMERA_VAR, 'entity_picture') }}"
            response_variable: result

          # 2.4 æ ¸å¿ƒæ•°å­¦æ¨¡å‹è®¡ç®— (EWMA å¹³æ»‘ç®—æ³•)
          - service: number.set_value
            data:
              value: "{{ result.result.detections | map(attribute=1) | sum | float }}"
            target:
              entity_id: number.bambu_lab_p1_spaghetti_detection_p_sum
          - service: number.set_value
            data:
              value: "{{ states('number.bambu_lab_p1_spaghetti_detection_current_frame_number') | float + 1 }}"
            target:
              entity_id: number.bambu_lab_p1_spaghetti_detection_current_frame_number
          - service: number.set_value
            data:
              value: "{{ states('number.bambu_lab_p1_spaghetti_detection_lifetime_frame_number') | float + 1 }}"
            target:
              entity_id: number.bambu_lab_p1_spaghetti_detection_lifetime_frame_number
          - service: number.set_value
            data:
              value: "{{ (states('number.bambu_lab_p1_spaghetti_detection_p_sum') | float) * (2 / (12 + 1)) + (states('number.bambu_lab_p1_spaghetti_detection_ewm_mean') | float) * (1 - (2 / (12 + 1))) }}"
            target:
              entity_id: number.bambu_lab_p1_spaghetti_detection_ewm_mean
          - service: number.set_value
            data:
              value: "{{ (states('number.bambu_lab_p1_spaghetti_detection_rolling_mean_short') | float) + ((states('number.bambu_lab_p1_spaghetti_detection_p_sum') | float) - (states('number.bambu_lab_p1_spaghetti_detection_rolling_mean_short') | float)) / (310 if 310 <= (states('number.bambu_lab_p1_spaghetti_detection_current_frame_number') | float) else (states('number.bambu_lab_p1_spaghetti_detection_current_frame_number') | float) + 1) }}"
            target:
              entity_id: number.bambu_lab_p1_spaghetti_detection_rolling_mean_short
          - service: number.set_value
            data:
              value: "{{ (states('number.bambu_lab_p1_spaghetti_detection_rolling_mean_long') | float) + ((states('number.bambu_lab_p1_spaghetti_detection_p_sum') | float) - (states('number.bambu_lab_p1_spaghetti_detection_rolling_mean_long') | float)) / (7200 if 7200 <= (states('number.bambu_lab_p1_spaghetti_detection_lifetime_frame_number') | float) else (states('number.bambu_lab_p1_spaghetti_detection_lifetime_frame_number') | float) + 1) }}"
            target:
              entity_id: number.bambu_lab_p1_spaghetti_detection_rolling_mean_long

          # é¢„çƒ­æœŸè¿‡æ»¤ (<30å¸§)
          - if:
              - condition: numeric_state
                entity_id: number.bambu_lab_p1_spaghetti_detection_current_frame_number
                below: 30
            then:
              - stop: "Warming up logic"

          # è®¡ç®—è°ƒæ•´åçš„ P å€¼ä¸é˜ˆå€¼
          - service: number.set_value
            data:
              value: "{{ (states('number.bambu_lab_p1_spaghetti_detection_ewm_mean') | float) - (states('number.bambu_lab_p1_spaghetti_detection_rolling_mean_long') | float) }}"
            target:
              entity_id: number.bambu_lab_p1_spaghetti_detection_adjusted_ewm_mean
          - service: number.set_value
            data:
              value: "{{ ((states('number.bambu_lab_p1_spaghetti_detection_rolling_mean_short') | float) - (states('number.bambu_lab_p1_spaghetti_detection_rolling_mean_long') | float)) * 3.8 }}"
            target:
              entity_id: number.bambu_lab_p1_spaghetti_detection_rolling_mean_diff
          - service: number.set_value
            data:
              value: "{{ min(0.78, max(0.33, (states('number.bambu_lab_p1_spaghetti_detection_rolling_mean_diff') | float))) }}"
            target:
              entity_id: number.bambu_lab_p1_spaghetti_detection_thresh_warning
          - service: number.set_value
            data:
              value: "{{ (states('number.bambu_lab_p1_spaghetti_detection_thresh_warning') | float) * 1.75 }}"
            target:
              entity_id: number.bambu_lab_p1_spaghetti_detection_thresh_failure
          - service: number.set_value
            data:
              value: "{{ (states('number.bambu_lab_p1_spaghetti_detection_ewm_mean') | float) - (states('number.bambu_lab_p1_spaghetti_detection_rolling_mean_long') | float) }}"
            target:
              entity_id: number.bambu_lab_p1_spaghetti_detection_p

          # å½’ä¸€åŒ–è®¡ç®—
          - choose:
              - conditions:
                  - condition: numeric_state
                    entity_id: number.bambu_lab_p1_spaghetti_detection_p
                    above: number.bambu_lab_p1_spaghetti_detection_thresh_failure
                sequence:
                  - service: number.set_value
                    data:
                      value: "{{ min(1.0, max(2.0 / 3.0, ((((states('number.bambu_lab_p1_spaghetti_detection_p') | float) - (states('number.bambu_lab_p1_spaghetti_detection_thresh_failure') | float)) * (1.0 - 2.0 / 3.0)) / ((states('number.bambu_lab_p1_spaghetti_detection_thresh_failure') | float) * 1.5 - (states('number.bambu_lab_p1_spaghetti_detection_thresh_failure') | float))) + 2.0 / 3.0)) }}"
                    target:
                      entity_id: number.bambu_lab_p1_spaghetti_detection_normalized_p
              - conditions:
                  - condition: numeric_state
                    entity_id: number.bambu_lab_p1_spaghetti_detection_p
                    above: number.bambu_lab_p1_spaghetti_detection_thresh_warning
                sequence:
                  - service: number.set_value
                    data:
                      value: "{{ min(2.0 / 3.0, max(1.0 / 3.0, ((((states('number.bambu_lab_p1_spaghetti_detection_p') | float) - (states('number.bambu_lab_p1_spaghetti_detection_thresh_warning') | float)) * (2.0 / 3.0 - 1.0 / 3.0)) / ((states('number.bambu_lab_p1_spaghetti_detection_thresh_failure') | float) - (states('number.bambu_lab_p1_spaghetti_detection_thresh_warning') | float))) + 1.0 / 3.0)) }}"
                    target:
                      entity_id: number.bambu_lab_p1_spaghetti_detection_normalized_p
            default:
              - service: number.set_value
                data:
                  value: "{{ min(1.0 / 3.0, max(0, ((states('number.bambu_lab_p1_spaghetti_detection_p') | float) * 1.0 / 3.0) / (states('number.bambu_lab_p1_spaghetti_detection_thresh_warning') | float))) }}"
                target:
                  entity_id: number.bambu_lab_p1_spaghetti_detection_normalized_p

          # å®‰å…¨è¿‡æ»¤ (é˜²æ­¢è¯¯æŠ¥)
          - if:
              - condition: numeric_state
                entity_id: number.bambu_lab_p1_spaghetti_detection_adjusted_ewm_mean
                below: 0.38
            then:
              - stop: "Low probability"
          - if:
              - condition: and
                conditions:
                  - condition: numeric_state
                    entity_id: number.bambu_lab_p1_spaghetti_detection_adjusted_ewm_mean
                    below: 0.78
                  - condition: numeric_state
                    entity_id: number.bambu_lab_p1_spaghetti_detection_adjusted_ewm_mean
                    below: number.bambu_lab_p1_spaghetti_detection_rolling_mean_diff
            then:
              - stop: "Below adaptive threshold"

          # é¢‘ç‡é™åˆ¶ (1åˆ†é’Ÿ)
          - if:
              - condition: template
                value_template: "{{ now() - states('datetime.bambu_lab_p1_spaghetti_detection_last_notify_time') | as_datetime | as_local < timedelta(minutes=1) }}"
            then:
              - stop: "Notification cooldown"

          # 2.5 è§¦å‘æŠ¥è­¦é€»è¾‘ (å½’ä¸€åŒ–æ¦‚ç‡ > 0.7)
          - if:
              - condition: template
                value_template: "{{ states('number.bambu_lab_p1_spaghetti_detection_normalized_p') | float > 0.7 }}"
            then:
              # å‘é€é€šçŸ¥åˆ° Gotify
              - service: rest_command.gotify_notification
                data:
                  title: "âš ï¸ ç‚’é¢æ£€æµ‹è­¦å‘Š"
                  message: "æ£€æµ‹åˆ°ç‚’é¢é£é™©ï¼š{{ (states('number.bambu_lab_p1_spaghetti_detection_normalized_p') | float * 100) | int }}%\n\nğŸ“· æ‘„åƒå¤´å¿«ç…§ï¼š\n{{ PUBLIC_HA_HOST_VAR }}{{ state_attr(PRINTER_CAMERA_VAR, 'entity_picture') }}"
                  priority: 8

              # æ›´æ–°æœ€åé€šçŸ¥æ—¶é—´
              - service: datetime.set_value
                data:
                  datetime: "{{ now() }}"
                target:
                  entity_id: datetime.bambu_lab_p1_spaghetti_detection_last_notify_time

              # æ‰§è¡Œæ‰“å°æœºåŠ¨ä½œ
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ FAILURE_ACTION_VAR == 'pause' }}"
                    sequence:
                      - service: button.press
                        target:
                          entity_id: !input printer_pause_button
                  - conditions:
                      - condition: template
                        value_template: "{{ FAILURE_ACTION_VAR == 'stop' }}"
                    sequence:
                      - service: button.press
                        target:
                          entity_id: !input printer_stop_button
